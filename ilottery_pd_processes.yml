---

- name: INIT
  hosts: pdprocesses
  become: false
  gather_facts: no
  tags:
    - init

  tasks:
    - name: Create local temp directory
      shell: "mktemp -d --tmpdir={{ g_base_tmpdir }} --suffix=_pdprocesses"
      delegate_to: 127.0.0.1
      run_once: true
      register: reg_tmpdir

    - set_fact:
        p_tmpdir: "{{ reg_tmpdir.stdout }}"

    - debug: msg="Created directory {{ p_tmpdir }}"
      delegate_to: 127.0.0.1
      run_once: true

    - name: Show Connection Infos
      debug: msg="ansible_host={{ ansible_host }}; ansible_user={{ ansible_user }}"

- name: STOP
  hosts: pdprocesses
  serial: 1
  become: true
  gather_facts: no
  tags:
    - stop

  tasks:
    - name: Stop Service
      systemd:
        name: "pd-processes"
        state: stopped
      ignore_errors: yes

- name: CLEANUP CONTAINER
  hosts: pdprocesses
  become: true
  gather_facts: no
  tags:
    - clean_config

  tasks:
    - name: Deleting Application Folder
      file:
        state: absent
        path: "/etc/gtech/pd/config/pd-processes/main"

- name: INSTALL
  hosts: pdprocesses
  become: true
  gather_facts: no
  tags:
    - install

  roles:
    - role: ilottery_pd_processes
      jboss_node_port_offset: 300

- name: START
  hosts: pdprocesses
  serial: 1
  become: true
  gather_facts: no
  tags:
    - start

  tasks:
    - name: Start Service
      systemd:
        name: "pd-processes"
        state: restarted
        enabled: yes
        daemon_reload: yes

- name: CLEAN
  hosts: pdprocesses
  become: false
  gather_facts: no
  tags:
    - clean

  tasks:
    - name: Remove local temp directory
      file:
        path: "{{ p_tmpdir }}"
        state: absent
      delegate_to: 127.0.0.1
      run_once: true

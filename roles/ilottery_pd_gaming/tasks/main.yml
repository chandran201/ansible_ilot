---
- set_fact:
    pd_gaming_packages:
      - "{{ config.siteName}}-translets-rpm"
      - "{{ config.siteName}}-gtech-translets-rpm"
      - "{{ config.siteName}}-essdk-connector-rpm"
      - "{{ config.siteName}}-essdk-translets-rpm"
      - "{{ config.siteName}}-gis-application-rpm"
      - "{{ config.siteName}}-event-detector-application-rpm"
      - "{{ config.siteName}}-txstore-read-application-rpm"
      - "{{ config.siteName}}-esa-instant-games-rpm"
      - "{{ config.siteName}}-instant-gratz-application-rpm"
      - "{{ config.siteName}}-esa-locations-rpm"
      - "{{ config.siteName}}-scan-store-application-rpm"
      - "{{ config.siteName}}-triggers-application-rpm"
      - "{{ config.siteName}}-global-config-rpm"
    jboss_common_packages:
      - "jolokia-1.3.3-1.x86_64"
      - "ric_db2driver-4.19.66-3.noarch"
      - "nodejs-5.11.1-1nodesource.el7.centos.x86_64"
      - "apr"
      - "openssl"
      - "coreutils"
      - "hawtio-no-slf4j-1.4.65-1"
    pd_gaming_main_tpls:
      - "{{ p_tmpdir }}/event-detector-core.properties.tpl"
      - "{{ p_tmpdir }}/event-detector-reference.properties.tpl"
      - "{{ p_tmpdir }}/event-detector-tcv.properties.tpl"
      - "{{ p_tmpdir }}/esa-configuration-triggers-internal.xml.tpl"
      - "{{ p_tmpdir }}/esa-configuration-triggers.xml.tpl"
      - "{{ p_tmpdir }}/crm-connector-client.properties.tpl"
    pd_gaming_gis_tpls:
      - "{{ p_tmpdir }}/esa-configuration-gis.xml.tpl"
      - "{{ p_tmpdir }}/event-processor-jms.properties.tpl"
      - "{{ p_tmpdir }}/gis.properties.tpl"
      - "{{ p_tmpdir }}/esa-configuration-gis-pa-balancing.xml.tpl"
      - "{{ p_tmpdir }}/esa-configuration-gis-pa-cart.xml.tpl"
      - "{{ p_tmpdir }}/esa-configuration-gis-pa-favorites.xml.tpl"
      - "{{ p_tmpdir }}/esa-configuration-gis-pa-groupplay.xml.tpl"
      - "{{ p_tmpdir }}/esa-configuration-gis-pa-params.xml.tpl"
      - "{{ p_tmpdir }}/esa-configuration-gis-pa-player.xml.tpl"
      - "{{ p_tmpdir }}/esa-configuration-gis-pa-quickpicks.xml.tpl"
      - "{{ p_tmpdir }}/esa-configuration-gis-pa-subscriptions.xml.tpl"
      - "{{ p_tmpdir }}/esa-configuration-gis-pa-wagering.xml.tpl"
    pd_gaming_este_tpls:
      - "{{ p_tmpdir }}/este.properties.tpl"
    pd_gaming_txstore_tpls:
      - "{{ p_tmpdir }}/esa-configuration-txstore.xml.tpl"
      - "{{ p_tmpdir }}/txstore.properties.tpl"
    pd_gaming_esa_tpls:
      - "{{ p_tmpdir }}/host.properties.tpl"
    pd_gaming_esa_locations_tpls:
      - "{{ p_tmpdir }}/esa-configuration-locations.xml.tpl"
      - "{{ p_tmpdir }}/locations-rest-context.xml.tpl"
    pd_gaming_instant_grantz_tpls:
      - "{{ p_tmpdir }}/esa-configuration-instant-gratz.xml.tpl"
      - "{{ p_tmpdir }}/instant-gratz.properties.tpl"
    pd_gaming_scan_store_tpls:
      - "{{ p_tmpdir }}/esa-configuration-scan-store.xml.tpl"
      - "{{ p_tmpdir }}/ref-scan-store-common-context.xml.tpl"
      - "{{ p_tmpdir }}/ref-scan-store.properties.tpl"
      - "{{ p_tmpdir }}/scan-store.properties.tpl"
    pd_gaming_triggers_tpls:
      - "{{ p_tmpdir }}/triggers.properties.tpl"
    global_config_tpls:
      - "{{ p_tmpdir }}/activemq.properties.tpl"
      - "{{ p_tmpdir }}/encryption.properties.tpl"
      - "{{ p_tmpdir }}/hsm.properties.tpl"
      - "{{ p_tmpdir }}/tivoli.properties.tpl"
      - "{{ p_tmpdir }}/walletparameters.properties.tpl"


- name: Install jboss common packages
  yum:
    name: "{{ item }}"
    state: present
    disable_gpg_check: yes
  with_items: "{{ jboss_common_packages }}"

- name: Remove application packages
  when: install_app == "true"
  yum:
    name: "{{ item }}"
    state: removed
    disable_gpg_check: yes
  with_items: "{{ pd_gaming_packages }}"

- name: Install application packages from yum repo
  when: install_app == "true"
  yum:
    name: "{{ item }}-{{ config.ilottery_version}}"
    state: present
    disable_gpg_check: yes
  with_items: "{{ pd_gaming_packages }}"

- name: Fetch templates
  when: install_app == "true"
  fetch:
    src: "{{ item.src}}"
    dest: "{{ item.dest }}"
    flat: yes
  become: false
  run_once: true
  with_items:
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-gis-env-config/src/main/env-config/es-configuration/gis/este.properties.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-gis-env-config/src/main/env-config/module/gis/esa-configuration-gis.xml.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-gis-env-config/src/main/env-config/module/gis/event-processor-jms.properties.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-gis-env-config/src/main/env-config/module/gis/gis.properties.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-gis-pa-env-config/src/main/env-config/module/gis/esa-configuration-gis-pa-balancing.xml.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-gis-pa-env-config/src/main/env-config/module/gis/esa-configuration-gis-pa-cart.xml.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-gis-pa-env-config/src/main/env-config/module/gis/esa-configuration-gis-pa-favorites.xml.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-gis-pa-env-config/src/main/env-config/module/gis/esa-configuration-gis-pa-groupplay.xml.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-gis-pa-env-config/src/main/env-config/module/gis/esa-configuration-gis-pa-params.xml.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-gis-pa-env-config/src/main/env-config/module/gis/esa-configuration-gis-pa-player.xml.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-gis-pa-env-config/src/main/env-config/module/gis/esa-configuration-gis-pa-quickpicks.xml.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-gis-pa-env-config/src/main/env-config/module/gis/esa-configuration-gis-pa-subscriptions.xml.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-gis-pa-env-config/src/main/env-config/module/gis/esa-configuration-gis-pa-wagering.xml.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-event-detector-env-config/src/main/env-config/event-detector-core.properties.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-event-detector-env-config/src/main/env-config/event-detector-reference.properties.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-event-detector-env-config/src/main/env-config/event-detector-tvc.properties.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-txstore-read-env-config/src/main/env-config/txstore/esa-configuration-txstore.xml.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-txstore-read-env-config/src/main/env-config/txstore/txstore.properties.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-esa-instant-games-env-config/src/main/env-config/es-configuration/host.properties.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-esa-locations-env-config/src/main/env-config/esa-locations/esa-configuration-locations.xml.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-esa-locations-env-config/src/main/env-config/esa-locations/locations-rest-context.xml.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-instant-gratz-env-config/src/main/env-config/instant-gratz/esa-configuration-instant-gratz.xml.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-instant-gratz-env-config/src/main/env-config/instant-gratz/instant-gratz.properties.xml.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-scan-store-env-config/src/main/env-config/module/scan-store/esa-configuration-scan-store.xml.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-scan-store-env-config/src/main/env-config/module/scan-store/ref-scan-store-common-context.xml.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-scan-store-env-config/src/main/env-config/module/scan-store/ref-scan-store.properties.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-scan-store-env-config/src/main/env-config/module/scan-store/scan-store.properties.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-scan-store-env-config/src/main/env-config/module/crm-connector-client.properties.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-triggers-env-config/src/main/env-config/esa-configuration-triggers-internal.xml.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-triggers-env-config/src/main/env-config/esa-configuration-triggers.xml.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/pd-gaming/{{ config.siteName }}-triggers-env-config/src/main/env-config/triggers/triggers.properties.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/{{ config.siteName }}-global-config/{{ config.siteName }}-global-config/src/main/env-config/activemq.properties.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/{{ config.siteName }}-global-config/{{ config.siteName }}-global-config/src/main/env-config/encryption.properties.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/{{ config.siteName }}-global-config/{{ config.siteName }}-global-config/src/main/env-config/hsm.properties.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/{{ config.siteName }}-global-config/{{ config.siteName }}-global-config/src/main/env-config/tivoli.properties.tpl", dest: "{{ p_tmpdir }}" }
    - { src: "/usr/local/gtech/{{ config.siteName }}-global-config/{{ config.siteName }}-global-config/src/main/env-config/walletparameters.properties.tpl", dest: "{{ p_tmpdir }}" }

- name: Create /etc/gtech/pd/config/pd-gaming/main folder
  file:
    path: /etc/gtech/pd/config/pd-gaming/main
    state: directory
    owner: jboss
    group: jboss
    mode: 0755

- name: Create /etc/gtech/pd/config/pd-gaming/main/esa-locations folder
  file:
    path: /etc/gtech/pd/config/pd-gaming/main/esa-locations
    state: directory
    owner: jboss
    group: jboss
    mode: 0755

- name: Create /etc/gtech/pd/config/pd-gaming/main/gis folder
  file:
    path: /etc/gtech/pd/config/pd-gaming/main/gis
    state: directory
    owner: jboss
    group: jboss
    mode: 0755

- name: Create /etc/gtech/pd/config/pd-gaming/main/instant-grantz folder
  file:
    path: /etc/gtech/pd/config/pd-gaming/main/instant-grantz
    state: directory
    owner: jboss
    group: jboss
    mode: 0755

- name: Create /etc/gtech/pd/config/pd-gaming/main/scan-store folder
  file:
    path: /etc/gtech/pd/config/pd-gaming/main/scan-store
    state: directory
    owner: jboss
    group: jboss
    mode: 0755

- name: Create /etc/gtech/pd/config/pd-gaming/main/triggers folder
  file:
    path: /etc/gtech/pd/config/pd-gaming/main/triggers
    state: directory
    owner: jboss
    group: jboss
    mode: 0755

- name: Create /etc/gtech/pd/config/pd-gaming/main/txstore folder
  file:
    path: /etc/gtech/pd/config/pd-gaming/main/txstore
    state: directory
    owner: jboss
    group: jboss
    mode: 0755

- name: Create /etc/gtech/gis folder
  file:
    path: /etc/gtech/gis
    state: directory
    owner: jboss
    group: jboss
    mode: 0755

- name: Create /etc/gtech/esa folder
  file:
    path: /etc/gtech/esa
    state: directory
    owner: jboss
    group: jboss
    mode: 0755

- name: Create /usr/share/jbossas/modules/com/gtech/translets/main folder
  file:
    path: /usr/share/jbossas/modules/com/gtech/translets/main
    state: directory
    owner: jboss
    group: jboss
    mode: 0755

- name: Parsing pd-gaming main templates
  when: install_app == "true"
  template:
    src: "{{ item }}"
    dest: "/etc/gtech/pd/config/pd-gaming/main/{{ item | basename | regex_replace('\\.tpl$', '') }}"
    mode: 0644
  with_fileglob: "{{ pd_gaming_main_tpls }}"

- name: Parsing pd-gaming gis templates
  when: install_app == "true"
  template:
    src: "{{ item }}"
    dest: "/etc/gtech/pd/config/pd-gaming/main/gis/{{ item | basename | regex_replace('\\.tpl$', '') }}"
    mode: 0644
  with_fileglob: "{{ pd_gaming_gis_tpls }}"

- name: Parsing pd-gaming este templates
  when: install_app == "true"
  template:
    src: "{{ item }}"
    dest: "/etc/gtech/gis/{{ item | basename | regex_replace('\\.tpl$', '') }}"
    mode: 0644
  with_fileglob: "{{ pd_gaming_este_tpls }}"

- name: Parsing pd-gaming esa templates
  when: install_app == "true"
  template:
    src: "{{ item }}"
    dest: "/etc/gtech/esa/{{ item | basename | regex_replace('\\.tpl$', '') }}"
    mode: 0644
  with_fileglob: "{{ pd_gaming_esa_tpls }}"

- name: Parsing pd-gaming txstore templates
  when: install_app == "true"
  template:
    src: "{{ item }}"
    dest: "/etc/gtech/pd/config/pd-gaming/main/txstore/{{ item | basename | regex_replace('\\.tpl$', '') }}"
    mode: 0644
  with_fileglob: "{{ pd_gaming_txstore_tpls }}"

- name: Parsing pd-gaming triggers templates
  when: install_app == "true"
  template:
    src: "{{ item }}"
    dest: "/etc/gtech/pd/config/pd-gaming/main/triggers/{{ item | basename | regex_replace('\\.tpl$', '') }}"
    mode: 0644
  with_fileglob: "{{ pd_gaming_triggers_tpls }}"

- name: Parsing pd-gaming scan-store templates
  when: install_app == "true"
  template:
    src: "{{ item }}"
    dest: "/etc/gtech/pd/config/pd-gaming/main/scan-store/{{ item | basename | regex_replace('\\.tpl$', '') }}"
    mode: 0644
  with_fileglob: "{{ pd_gaming_scan_store_tpls }}"

- name: Parsing pd-gaming esa-locations templates
  when: install_app == "true"
  template:
    src: "{{ item }}"
    dest: "/etc/gtech/pd/config/pd-gaming/main/esa-locations/{{ item | basename | regex_replace('\\.tpl$', '') }}"
    mode: 0644
  with_fileglob: "{{ pd_gaming_esa_locations_tpls }}"

- name: Parsing pd-gaming instant-grantz templates
  when: install_app == "true"
  template:
    src: "{{ item }}"
    dest: "/etc/gtech/pd/config/pd-gaming/main/instant-grantz/{{ item | basename | regex_replace('\\.tpl$', '') }}"
    mode: 0644
  with_fileglob: "{{ pd_gaming_instant_grantz_tpls }}"

- name: Parsing global-config templates
  when: install_app == "true"
  template:
    src: "{{ item }}"
    dest: "/etc/gtech/pd/config/pd-global/main/{{ item | basename | regex_replace('\\.tpl$', '') }}"
    mode: 0644
  with_fileglob: "{{ global_config_tpls }}"

 # END products configurations 

- name: Install security limits
  template:
    src: "templates/security/limits.conf"
    dest: "/etc/security/limits.conf"
    mode: 0644
    owner: root
    group: root

- name: Create /opt/jboss/modules/system/layers/base/javax/validation/api/1.1.0/ dir
  file:
    path: /opt/jboss/modules/system/layers/base/javax/validation/api/1.1.0
    state: directory
    owner: jboss
    group: jboss
    mode: 0755

- name: Install /opt/jboss/modules/system/layers/base/javax/validation/api/1.1.0/module.xml template
  template:
    src: "templates/jboss/modules/system/layers/base/javax/validation/api/1.1.0/module.xml"
    dest: "/opt/jboss/modules/system/layers/base/javax/validation/api/1.1.0/module.xml"
    mode: 0644
    owner: jboss
    group: jboss

- name: Copying 
  copy:
    src: "files/jbossas/jblogrotate.sh"
    dest: "/etc/jbossas/jblogrotate.sh"
    owner: root
    group: root
    mode: 0755

- name: Install jboss cron logrotation /etc/jbossas/jblogrotate.sh
  when: enable_logremoval
  cron:
    name: "jboss logrotation jblogrotate.sh"
    minute: "0"
    hour: "23"
    user: "root"
    job: "/etc/jbossas/jblogrotate.sh {{ keep_logs_days }}"

- name: Setting correct permissions/ownership on various directories
  file:
    path: "{{ item }}"
    state: directory
    owner: jboss
    group: jboss
    mode: 0755
  with_items:
    - "/usr/share/jbossas/modules/com/gtech/pd/config/{{ instance_name }}"
    - "/etc/gtech"
    - "/etc/gtech/gis"
    - "/etc/gtech/esa"
    - "/usr/share/jbossas/modules/com/gtech/pd/config/pd-global"
    - "/etc/gtech/pd/config/pd-global/main"
    - "/usr/share/jbossas/modules/com/gtech/pd/config/pd-gaming-esa"
    - "/etc/gtech/pd/config/pd-gaming-esa/main"
    - "/usr/share/jbossas/modules/com/gtech/translets/main/"
    - "/etc/gtech/pd/config/{{ instance_name }}/main"

- name: "Create symlinks /usr/share/jbossas/modules/com/gtech/pd/config/{{ instance_name }}/main to /etc/gtech/pd/config/{{ instance_name }}/main"
  file:
    src: "/etc/gtech/pd/config/{{ instance_name }}/main"
    dest: "/usr/share/jbossas/modules/com/gtech/pd/config/{{ instance_name }}/main"
    state: link

- name: Create symlinks /usr/share/jbossas/modules/com/gtech/pd/config/pd-global/main to /etc/gtech/pd/config/pd-global/main
  file:
    src: "/etc/gtech/pd/config/pd-global/main"
    dest: "/usr/share/jbossas/modules/com/gtech/pd/config/pd-global/main"
    state: link

- name: "Install /etc/gtech/pd/config/{{ instance_name }}/main/module.xml template"
  template:
    src: "templates/gtech/pd/config/{{ instance_name }}/main/module.xml"
    dest: "/etc/gtech/pd/config/{{ instance_name }}/main/module.xml"
    mode: 0644
    owner: jboss
    group: jboss

- name: Install /etc/gtech/pd/config/pd-global/main/module.xml template
  template:
    src: "templates/gtech/pd/config/pd-global/main/module.xml"
    dest: "/etc/gtech/pd/config/pd-global/main/module.xml"
    mode: 0644
    owner: jboss
    group: jboss

- name: Install /etc/gtech/pd/config/pd-gaming-esa/main/module.xml template
  template:
    src: "templates/gtech/pd/config/pd-gaming-esa/main/module.xml"
    dest: "/etc/gtech/pd/config/pd-gaming-esa/main/module.xml"
    mode: 0644
    owner: jboss
    group: jboss

- name: Install /usr/share/jbossas/modules/com/gtech/translets/main/module.xml template
  when: load_translets|bool == true
  template:
    src: "templates/gtech/translets/main/module.xml"
    dest: "/usr/share/jbossas/modules/com/gtech/translets/main/module.xml"
    mode: 0644
    owner: jboss
    group: jboss

- name: Remove /usr/share/jbossas/modules/com/gtech/translets/main/module.xml file
  when: load_translets|bool == false
  file:
    dest: "/usr/share/jbossas/modules/com/gtech/translets/main/module.xml"
    state: absent

- name: "Remove /usr/share/jbossas/{{ instance_name }}/deployments/essdk-connector.rar file"
  when: load_translets|bool == false
  file:
    dest: "/usr/share/jbossas/{{ instance_name }}/deployments/essdk-connector.rar"
    state: absent

- name: "Remove /usr/share/java/essdk-connector.rar file"
  when: load_translets|bool == false
  file:
    dest: "/usr/share/java/essdk-connector.rar"
    state: absent

- name: "Create symlinks /usr/share/jbossas/{{ instance_name }}/deployments/db2jcc4.jar to /usr/share/java/db2jcc4.jar"
  file:
    src: "/usr/share/java/db2jcc4.jar"
    dest: "/usr/share/jbossas/{{ instance_name }}/deployments/db2jcc4.jar"
    state: link

- name: "Create symlinks /usr/share/jbossas/{{ instance_name }}/deployments/jolokia.war to /var/lib/jolokia/jolokia.war"
  file:
    src: "/var/lib/jolokia/jolokia.war"
    dest: "/usr/share/jbossas/{{ instance_name }}/deployments/jolokia.war"
    state: link

- name: "Create symlinks /usr/share/jbossas/{{ instance_name }}/deployments/essdk-connector.rar to /usr/share/java/essdk-connector.rar"
  when: load_translets|bool == true and install_app == "true"
  file:
    src: "/usr/share/java/essdk-connector.rar"
    dest: "/usr/share/jbossas/{{ instance_name }}/deployments/essdk-connector.rar"
    state: link

- name: "Inline entry Port 22"
  lineinfile:
    dest: "/etc/ssh/sshd_config"
    regexp: '^Port 22'
    line: 'Port 22'
  notify:
    - restart sshd

- name: "Inline entry Port 40022"
  lineinfile:
    dest: "/etc/ssh/sshd_config"
    regexp: '^Port 40022'
    line: 'Port 40022'
  notify:
    - restart sshd

- name: Create symlinks /opt/jdk to /usr/lib/jvm/java
  file:
    src: "/usr/lib/jvm/java"
    dest: "/opt/jdk"
    state: link

- name: Create hash for jboss mgmt password
  shell: echo "{{ jboss_management_user }}:ManagementRealm:{{ jboss_management_pass }}" | md5sum | cut -d ' ' -f 1
  register: md5jbosspwd

- set_fact: 
    jboss_real_management_pass: "{{ md5jbosspwd.stdout }}"

- name: Install mgmt-users.properties template
  template:
    src: "templates/configuration/mgmt-users.properties"
    dest: "/etc/jbossas/{{ instance_name }}/mgmt-users.properties"
    mode: 0644
    owner: jboss
    group: jboss

- name: Create hash for jboss ejb password
  shell: echo "{{ ejbuser }}:ApplicationRealm:{{ ejbpassword }}" | md5sum | cut -d ' ' -f 1
  register: md5jbossejbpwd

- set_fact:
    realejbpassword: "{{ md5jbossejbpwd.stdout }}"

- name: Create hash for jboss jms password
  shell: echo "{{ jms_user }}:ApplicationRealm:{{ jms_pass }}" | md5sum | cut -d ' ' -f 1
  register: md5jbossjmspwd

- set_fact:
    realjmspassword: "{{ md5jbossjmspwd.stdout }}"

- name: Create hash for jboss hawtio password
  shell: echo "{{ hawtio_user }}:ApplicationRealm:{{ hawtio_pass }}" | md5sum | cut -d ' ' -f 1
  register: md5jbosshawtiopwd

- set_fact:
    realhawtiopassword: "{{ md5jbosshawtiopwd.stdout }}"

- name: Install application-users.properties template
  template:
    src: "templates/configuration/application-users.properties"
    dest: "/etc/jbossas/{{ instance_name }}/application-users.properties"
    mode: 0644
    owner: jboss
    group: jboss

- name: Create hash forejb-security-realm secret
  shell: echo -n "{{ ejbpassword }}" | base64
  register: forejb_security_realm_secret

- set_fact:
    real_forejb_security_realm_secret: "{{ forejb_security_realm_secret.stdout }}"

- name: Install jboss configuration templates
  template:
    src: "templates/configuration/{{ item }}"
    dest: "/etc/jbossas/{{ instance_name }}/{{ item }}"
    mode: 0644
    owner: jboss
    group: jboss
  with_items:
    - application-roles.properties
    - application-users.properties
    - logging.properties
    - mgmt-groups.properties
    - mgmt-users.properties

- name: Install jboss configuration file
  template:
    src: "templates/configuration/standalone-full-ha.xml"
    dest: "/etc/jbossas/{{ instance_name }}/standalone-automation-{{ instance_name }}.xml"
    mode: 0644
    owner: jboss
    group: jboss
